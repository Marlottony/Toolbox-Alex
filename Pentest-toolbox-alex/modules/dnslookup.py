import requests
import json

from menu import displayMenu

def DNSLookUp(domain, htmlRender=False):
    domainName = str(domain)
    URL = f"https://networkcalc.com/api/dns/lookup/{domainName}"
    query = requests.get(URL)
    displayInfos = ""
    sp = "&nbsp;" * 15
    maxLen = 8

    if htmlRender:
        spacing = "<br>"  # Pour le rendu PDF
    else:
        spacing = "\n"

    if query.status_code != 200:
        displayInfos = f"{spacing}Check your domain name or the API website (https://networkcalc.com/api/)"
    else:
        data = json.loads(query.text)
        status = data['status']

        if status == 'OK':
            if not htmlRender:
                displayInfos = f"\n\n========================================\n"
                displayInfos+= f"DNS Informations about {data['hostname']}\n"
                displayInfos+= f"==========================================\n\n"
            else:
                displayInfos+=f"""
                <table style="width:100%">
                    <tr>
                        <th>Record name</th>
                        <th>Informations and data</th>
                    </tr>
                """

            records = data['records']

            for record in records:
                newSpace = maxLen - len(record)
                spaceTag = "&nbsp;" * newSpace

                if not records[record]:
                    if htmlRender:
                        displayInfos+=f"<tr><td>{spaceTag}{record}{spaceTag}</td><td>No record found</td></tr>"
                    else:
                        displayInfos+=f"{record} : \tNo record found\n"

                else:
                    if htmlRender:
                        displayInfos+=f"<tr><td>{spaceTag}{record}{spaceTag}</td><td>{records[record]}</td></tr>"
                    else:
                        displayInfos+=f"{record} : {records[record]}\n"

            if htmlRender:
                displayInfos+= "</table>"

        else:
            if status == 'NO_RECORDS':
                displayInfos = f"{spacing}No records. Check if the domain is reachable.{spacing}"
            else:
                displayInfos = "Error with the API, check https://networkcalc.com/api/dns/lookup/"

    return displayInfos

def main():
    while True:
        displayMenu()
        print("\n>>> Choose an option")
        print(">>> " + "-" * 25)
        print(">>> 1. Look up a domain")
        print(">>> 2. Quit")
        print(">>> " + "-" * 25)

        option = input(">>> ")

        if option == '1':
            while True:
                domain = input("\n>>> Enter the domain you want to look up: ")
                if domain == 'z':
                    break
                print(DNSLookUp(domain))
                print(">>> " + "-" * 25)
                print(">>> 1. Look up another domain")
                print(">>> 2. Return to main menu")
                print(">>> " + "-" * 25)
                subOption = input(">>> ")
                if subOption == '1':
                    pass
                elif subOption == '2':
                    break
                else:
                    print(">>> Invalid option")

        elif option == '2':
            print("\n>>> Goodbye!")
            break

        else:
            print("\n>>> Invalid option")

if __name__ == "__main__":
    main()